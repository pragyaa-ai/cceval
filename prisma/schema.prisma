// Prisma schema for HCE Evaluations
// PostgreSQL database hosted on GCP VM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// MULTI-TENANT ORGANIZATION MODEL
// ==========================================

// Organization - Top-level entity for multi-tenancy
model Organization {
  id          String   @id @default(cuid())
  name        String   // Company name (e.g., "Mahindra", "HDFC Bank")
  slug        String   @unique // URL-friendly identifier (e.g., "mahindra", "hdfc-bank")
  logo        String?  // Logo URL
  description String?  @db.Text
  
  // Branding & Customization
  primaryColor   String @default("#7c3aed") // Violet-500
  secondaryColor String @default("#8b5cf6") // Violet-400
  
  // Settings
  isActive    Boolean  @default(true)
  settings    String?  @db.Text // JSON for additional settings
  
  // Relationships
  users       User[]
  scenarios   EvaluationScenario[]
  batches     Batch[]
  calibrations OrganizationCalibration[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// CUSTOM EVALUATION SCENARIOS
// ==========================================

// EvaluationScenario - Custom scenario created by organization
model EvaluationScenario {
  id          String   @id @default(cuid())
  name        String   // "Credit Card Sales Evaluation"
  description String   @db.Text // Detailed description of the scenario
  industry    String?  // "Banking", "Automotive", "Telecom", etc.
  roleType    String?  // "Sales", "Support", "Collections", etc.
  
  // Organization relationship
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Scenario Configuration
  agentName        String  @default("Eva") // AI agent name
  agentVoice       String  @default("coral") // OpenAI voice
  agentPersona     String  @db.Text @default("") // Custom persona description
  agentInstructions String @db.Text @default("") // Full AI agent instructions (generated or custom)
  
  // Evaluation Flow Configuration (JSON)
  // Contains: phases, role-play scenarios, empathy scenarios, etc.
  flowConfig       String  @db.Text @default("{}") 
  
  // Status
  status      String   @default("draft") // draft, active, archived
  isDefault   Boolean  @default(false)   // Default scenario for organization
  
  // Relationships
  criteria        ScoringCriteria[]
  readingPassages ReadingPassage[]
  rolePlayScenarios RolePlayScenario[]
  sampleRecordings SampleRecording[]
  batches         Batch[]
  
  // Creator
  createdById String?
  createdBy   User?    @relation("ScenarioCreator", fields: [createdById], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([organizationId])
}

// ScoringCriteria - Custom evaluation criteria for a scenario
model ScoringCriteria {
  id          String   @id @default(cuid())
  parameterId String   // Unique identifier within scenario (e.g., "product_knowledge")
  label       String   // Display label (e.g., "Product Knowledge")
  description String   @db.Text // What this criteria measures
  
  // Scoring configuration
  minScore    Int      @default(1)
  maxScore    Int      @default(5)
  weight      Float    @default(1.0) // Weight for overall score calculation
  
  // AI Guidance
  scoringGuidance String @db.Text @default("") // Instructions for AI on how to score
  
  // Examples for each score level (JSON array)
  // [{ score: 1, description: "...", example: "..." }, ...]
  scoreExamples   String @db.Text @default("[]")
  
  // Category for grouping
  category    String   @default("general") // voice_quality, communication, domain_knowledge, etc.
  
  // Order in which criteria appear
  displayOrder Int     @default(0)
  
  // Whether this is required or optional
  isRequired  Boolean  @default(true)
  isActive    Boolean  @default(true)
  
  // AI-suggested flag
  isSuggested Boolean  @default(false) // Was this suggested by AI analysis?
  
  // Scenario relationship
  scenarioId  String
  scenario    EvaluationScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([scenarioId, parameterId])
  @@index([scenarioId])
}

// ReadingPassage - Custom reading passages for voice assessment
model ReadingPassage {
  id          String   @id @default(cuid())
  title       String   // "Credit Card Benefits"
  text        String   @db.Text // The passage text
  wordCount   Int      @default(0)
  
  // Industry/domain context
  context     String?  @db.Text // Why this passage is relevant
  
  // Difficulty level
  difficulty  String   @default("medium") // easy, medium, hard
  
  // Status
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  
  // Scenario relationship
  scenarioId  String
  scenario    EvaluationScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([scenarioId])
}

// RolePlayScenario - Custom role-play scenarios for call simulations
model RolePlayScenario {
  id              String   @id @default(cuid())
  title           String   // "Angry Customer - Card Blocked"
  description     String   @db.Text // Scenario description
  
  // Customer persona
  customerName    String   @default("Customer") // "Rita Sharma"
  customerPersona String   @db.Text // Detailed persona description
  customerMood    String   @default("neutral") // neutral, frustrated, confused, angry, happy
  
  // Opening line and context
  openingLine     String   @db.Text // Initial customer statement
  context         String   @db.Text // Background context for the scenario
  
  // Expected behaviors (JSON array of strings)
  expectedBehaviors String @db.Text @default("[]")
  
  // Escalation triggers (JSON array)
  escalationTriggers String @db.Text @default("[]")
  
  // Difficulty
  difficulty      String   @default("beginner") // beginner, moderate, experienced
  
  // Status
  isActive        Boolean  @default(true)
  displayOrder    Int      @default(0)
  
  // Scenario relationship
  scenarioId      String
  scenario        EvaluationScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([scenarioId])
}

// SampleRecording - Sample call recordings for AI analysis
model SampleRecording {
  id          String   @id @default(cuid())
  title       String   // "Good Sales Call Example"
  description String?  @db.Text
  
  // Recording details
  fileUrl     String   // URL to the audio file
  fileName    String
  fileSize    Int      @default(0) // in bytes
  duration    Int      @default(0) // in seconds
  mimeType    String   @default("audio/webm")
  
  // AI Analysis Results
  transcript      String?  @db.Text // Transcribed text
  analysisResult  String?  @db.Text // JSON with AI analysis
  suggestedCriteria String? @db.Text // JSON array of suggested criteria from AI
  analysisStatus  String   @default("pending") // pending, processing, completed, failed
  
  // Quality indicator
  qualityLabel    String?  // "good", "average", "poor" - evaluator marked
  
  // Scenario relationship
  scenarioId  String
  scenario    EvaluationScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  
  // Uploaded by
  uploadedById String?
  uploadedBy   User?    @relation("RecordingUploader", fields: [uploadedById], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([scenarioId])
}

// ==========================================
// NEXTAUTH.JS MODELS
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==========================================
// USER MODEL (Extended for multi-tenancy)
// ==========================================

// Evaluator (extends NextAuth User)
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("evaluator") // evaluator, admin, org_admin, hr
  
  // Organization relationship (for multi-tenancy)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  accounts Account[]
  sessions Session[]
  
  // Evaluation relationships
  batchesCreated    Batch[]      @relation("BatchCreator")
  evaluationsScored Evaluation[] @relation("EvaluationScorer")
  feedbacks         EvaluatorFeedback[] @relation("EvaluatorFeedbacks")
  
  // Scenario relationships
  scenariosCreated  EvaluationScenario[] @relation("ScenarioCreator")
  recordingsUploaded SampleRecording[] @relation("RecordingUploader")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([organizationId])
}

// ==========================================
// EVALUATION MODELS (Updated for scenarios)
// ==========================================

// Evaluation Batch
model Batch {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Creator
  creatorId String
  creator   User   @relation("BatchCreator", fields: [creatorId], references: [id])
  
  // Organization (for multi-tenancy)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Scenario to use for this batch
  scenarioId String?
  scenario   EvaluationScenario? @relation(fields: [scenarioId], references: [id])
  
  // Candidates in this batch
  candidates Candidate[]
  
  // Status
  status String @default("active") // active, archived, completed
  
  @@index([organizationId])
  @@index([scenarioId])
}

// Candidate
model Candidate {
  id         String   @id @default(cuid())
  name       String
  email      String?
  phone      String?
  accessCode String   @unique
  status     String   @default("pending") // pending, in_progress, completed, cancelled
  
  // Demographics (for voice quality analysis calibration)
  age            Int?      // Age in years
  gender         String?   // male, female, other
  nativeLanguage String?   // Primary language for accent consideration
  
  // Batch relationship
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)
  
  // Evaluation settings
  selectedPassage  String @default("safety_adas")
  selectedScenario String @default("beginner")
  
  // Evaluation data
  evaluation Evaluation?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Evaluation Session
model Evaluation {
  id          String   @id @default(cuid())
  sessionId   String   @unique // MHCE-xxx format
  
  // Candidate relationship
  candidateId String   @unique
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  // Evaluator who scored this
  scorerId    String?
  scorer      User?    @relation("EvaluationScorer", fields: [scorerId], references: [id])
  
  // Phase tracking
  currentPhase String @default("not_started")
  
  // Timing
  startTime DateTime?
  endTime   DateTime?
  
  // Recording
  recordingUrl      String?
  recordingDuration Int      @default(0) // in seconds
  
  // Voice Quality Analysis (JSON data from reading phase)
  voiceAnalysisData String? @db.Text // JSON containing clarity, volume, tone, pace, overall score, recommendations
  
  // Manager Recommendation
  managerDecision      String?   // hire, dont_hire, improvement_needed
  managerComments      String?   @db.Text
  managerName          String?
  managerDesignation   String?
  managerDecisionAt    DateTime?
  
  // HR Decision
  hrDecision           String?   // hire, dont_hire, improvement_needed
  hrComments           String?   @db.Text
  hrName               String?
  hrDesignation        String?
  hrDecisionAt         DateTime?
  
  // Related data
  scores          Score[]
  transcriptItems TranscriptItem[]
  phaseResults    PhaseResult[]
  feedbacks       EvaluatorFeedback[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Score Entry
model Score {
  id          String @id @default(cuid())
  parameterId String // clarity_pace, product_knowledge, etc.
  score       Int    // 1-5
  notes       String @default("")
  
  evaluationId String
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  
  // Evaluator feedback on this score
  feedbacks EvaluatorFeedback[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([evaluationId, parameterId])
}

// Evaluator Feedback - Human review of AI-generated evaluations
model EvaluatorFeedback {
  id           String   @id @default(cuid())
  
  // Can be associated with a specific score parameter or voice quality metric
  scoreId      String?  // For score parameter feedback (nullable)
  score        Score?   @relation(fields: [scoreId], references: [id], onDelete: Cascade)
  
  evaluationId String   // Always linked to an evaluation
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  
  // Feedback type: "score" for scoring parameters, "voice_quality" for voice metrics
  feedbackType String   @default("score") // score, voice_quality
  
  // For voice quality feedback, specify which metric (clarity, volume, tone, pace, overall)
  voiceMetric  String?  // clarity, volume, tone, pace, overall
  
  // The human evaluator providing feedback
  evaluatorId  String
  evaluator    User     @relation("EvaluatorFeedbacks", fields: [evaluatorId], references: [id])
  
  // Original AI score (preserved for comparison)
  originalScore Int?    // 1-5 for scoring, or percentage for voice metrics
  
  // Human-adjusted score
  adjustedScore Int?    // New score provided by evaluator
  
  // Feedback comment explaining the adjustment
  comment      String   @db.Text
  
  // Session tracking for history
  sessionDate  DateTime @default(now())
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Transcript Item
model TranscriptItem {
  id       String @id @default(cuid())
  role     String // candidate, agent, system
  content  String @db.Text
  phase    String
  
  evaluationId String
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

// Phase Result
model PhaseResult {
  id          String @id @default(cuid())
  phase       String
  duration    Int    @default(0) // in seconds
  notes       String @default("")
  
  evaluationId String
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  
  completedAt DateTime @default(now())
}

// ==========================================
// CALIBRATION MODELS (Updated for org-level)
// ==========================================

// Organization-level calibration (replaces global AgentCalibration)
model OrganizationCalibration {
  id          String   @id @default(cuid())
  parameterId String   // clarity_pace, product_knowledge, confidence, etc.
  
  // Organization relationship
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Calibration adjustment (-2 to +2, applied to AI scores)
  adjustment  Float    @default(0)
  
  // Guidance text included in AI prompts for this parameter
  guidance    String   @db.Text @default("")
  
  // Statistics from feedback analysis
  totalFeedbacks    Int @default(0)  // Total feedback entries analyzed
  avgAdjustment     Float @default(0) // Average adjustment direction
  lastAnalyzedAt    DateTime?         // When analysis was last run
  
  // Tracking
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([organizationId, parameterId])
  @@index([organizationId])
}

// Legacy global calibration (for backwards compatibility)
model AgentCalibration {
  id          String   @id @default(cuid())
  parameterId String   @unique // clarity_pace, product_knowledge, confidence, etc.
  
  // Calibration adjustment (-2 to +2, applied to AI scores)
  adjustment  Float    @default(0)
  
  // Guidance text included in AI prompts for this parameter
  guidance    String   @db.Text @default("")
  
  // Statistics from feedback analysis
  totalFeedbacks    Int @default(0)  // Total feedback entries analyzed
  avgAdjustment     Float @default(0) // Average adjustment direction
  lastAnalyzedAt    DateTime?         // When analysis was last run
  
  // Tracking
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // History of changes
  history     CalibrationHistory[]
}

// Calibration History - Track all changes to calibrations
model CalibrationHistory {
  id             String   @id @default(cuid())
  
  calibrationId  String
  calibration    AgentCalibration @relation(fields: [calibrationId], references: [id], onDelete: Cascade)
  
  // Previous values (before this change)
  previousAdjustment Float
  previousGuidance   String @db.Text
  
  // New values (after this change)
  newAdjustment      Float
  newGuidance        String @db.Text
  
  // Analysis details
  feedbackCount      Int      // Number of feedbacks analyzed for this update
  periodStart        DateTime // Analysis period start
  periodEnd          DateTime // Analysis period end
  
  // Summary of why the change was made
  analysisSummary    String   @db.Text
  
  // Which evaluators contributed feedback
  evaluatorIds       String   @db.Text // JSON array of evaluator IDs
  
  createdAt          DateTime @default(now())
}
